
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/src/snake/SnakeBoard.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'a84adR6dohB5YJuAMwnUu08', 'SnakeBoard');
// src/snake/SnakeBoard.ts

Object.defineProperty(exports, "__esModule", { value: true });
var SnakeConstants_1 = require("./SnakeConstants");
var SnakePiece_1 = require("./SnakePiece");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
var Board = /** @class */ (function (_super) {
    __extends(Board, _super);
    function Board() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.frameTime = 0.5;
        _this.levelRatio = 0.05;
        _this.piecePrefab = null;
        _this.layout = null;
        _this.isStart = false;
        _this.pastTime = 0;
        _this.rowsNum = 16;
        _this.colsNum = 16;
        _this.gridWidth = 0;
        _this.moveDir = SnakeConstants_1.DIRECTION.RIGHT;
        _this.level = 0;
        _this.snakeScene = null;
        return _this;
        // update(dt: number) {
        //     if (this.isStart) {
        //         this.pastTime += dt;
        //         if (this.pastTime >= this.frameTime * (this.levelRatio**this.level)) {
        //             this.moveSnake();
        //             this.pastTime = 0;
        //         }
        //     }
        // }
    }
    Board.prototype.onLoad = function () {
        this.gridWidth = this.layout.width / this.colsNum;
        this.pieceMap = [];
        for (var x = 0; x < this.colsNum; x++) {
            this.pieceMap[x] = [];
            for (var y = 0; y < this.rowsNum; y++) {
                var pieceNode = cc.instantiate(this.piecePrefab);
                this.layout.addChild(pieceNode);
                pieceNode.width = this.gridWidth;
                pieceNode.height = this.gridWidth;
                pieceNode.x = x * this.gridWidth + pieceNode.width / 2;
                pieceNode.y = y * this.gridWidth + pieceNode.height / 2;
                this.pieceMap[x][y] = pieceNode.getComponent(SnakePiece_1.Piece);
                this.pieceMap[x][y].x = x;
                this.pieceMap[x][y].y = y;
            }
        }
    };
    Board.prototype.updateTick = function () {
        this.unschedule(this.tickHandler);
        var time = this.frameTime - (this.levelRatio * this.level);
        if (time < 0.1) {
            time = 0.1;
        }
        this.schedule(this.tickHandler, time);
    };
    Board.prototype.tickHandler = function () {
        if (this.isStart) {
            this.moveSnake();
        }
    };
    Board.prototype.init = function (snakeScene) {
        this.snakeScene = snakeScene;
    };
    Board.prototype.startGame = function () {
        this.reset();
        for (var i = 0; i < 10; i++) {
            this.addFood();
        }
        this.isStart = true;
        this.updateTick();
    };
    Board.prototype.reset = function () {
        this.clear();
        this.snake = [];
        this.pieceMap[9][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.RIGHT);
        this.pieceMap[8][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.RIGHT);
        this.pieceMap[7][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.UP);
        this.pieceMap[7][8].init(SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL, SnakeConstants_1.DIRECTION.UP, SnakeConstants_1.DIRECTION.UP);
        this.snake.push(this.pieceMap[9][9]);
        this.snake.push(this.pieceMap[8][9]);
        this.snake.push(this.pieceMap[7][9]);
        this.snake.push(this.pieceMap[7][8]);
        this.moveDir = SnakeConstants_1.DIRECTION.RIGHT;
        this.level = 0;
    };
    Board.prototype.addFood = function () {
        var blankList = [];
        for (var x = 0; x < this.colsNum; x++) {
            for (var y = 0; y < this.rowsNum; y++) {
                if (this.pieceMap[x][y].type === SnakeConstants_1.PIECE_TYPE.BLANK) {
                    blankList.push(this.pieceMap[x][y]);
                }
            }
        }
        var randomPiece = blankList[(Math.random() * blankList.length) | 0];
        randomPiece.type = SnakeConstants_1.PIECE_TYPE.FOOD;
    };
    Board.prototype.clear = function () {
        for (var x = 0; x < this.colsNum; x++) {
            for (var y = 0; y < this.rowsNum; y++) {
                this.pieceMap[x][y].type = SnakeConstants_1.PIECE_TYPE.BLANK;
            }
        }
    };
    Board.prototype.updateLevel = function (level) {
        if (level !== this.level) {
            this.level = level;
            this.updateTick();
        }
    };
    Board.prototype.turnSnake = function (dir) {
        if (this.snake[0].outDir !== -dir) {
            this.moveDir = dir;
        }
    };
    Board.prototype.moveSnake = function () {
        var head = this.snake[0];
        head.inDir = this.snake[1].outDir;
        head.outDir = this.moveDir;
        var nextPiece;
        switch (head.outDir) {
            case SnakeConstants_1.DIRECTION.UP:
                if (head.y === this.rowsNum - 1) {
                    nextPiece = this.pieceMap[head.x][0];
                }
                else {
                    nextPiece = this.pieceMap[head.x][head.y + 1];
                }
                break;
            case SnakeConstants_1.DIRECTION.RIGHT:
                if (head.x === this.colsNum - 1) {
                    nextPiece = this.pieceMap[0][head.y];
                }
                else {
                    nextPiece = this.pieceMap[head.x + 1][head.y];
                }
                break;
            case SnakeConstants_1.DIRECTION.DOWN:
                if (head.y === 0) {
                    nextPiece = this.pieceMap[head.x][this.rowsNum - 1];
                }
                else {
                    nextPiece = this.pieceMap[head.x][head.y - 1];
                }
                break;
            case SnakeConstants_1.DIRECTION.LEFT:
                if (head.x === 0) {
                    nextPiece = this.pieceMap[this.colsNum - 1][head.y];
                }
                else {
                    nextPiece = this.pieceMap[head.x - 1][head.y];
                }
                break;
        }
        this.moveSnakeToPiece(nextPiece);
    };
    Board.prototype.moveSnakeToPiece = function (nextPiece) {
        var head = this.snake[0];
        switch (nextPiece.type) {
            case SnakeConstants_1.PIECE_TYPE.SNAKE_BODY:
            case SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL:
                this.isStart = false;
                this.snakeScene.overGame();
                break;
            case SnakeConstants_1.PIECE_TYPE.FOOD:
                nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, head.outDir, head.inDir);
                head.init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, head.outDir, head.inDir);
                this.snake.unshift(nextPiece);
                this.snakeScene.onEatFood();
                break;
            case SnakeConstants_1.PIECE_TYPE.BLANK:
                var newSnake_1 = [];
                this.snake.forEach(function (piece, index) {
                    switch (piece.type) {
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, piece.outDir, piece.inDir);
                            break;
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_BODY:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, nextPiece.outDir, piece.outDir);
                            break;
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL, nextPiece.outDir, piece.outDir);
                            piece.type = SnakeConstants_1.PIECE_TYPE.BLANK;
                            break;
                    }
                    newSnake_1.push(nextPiece);
                    nextPiece = piece;
                });
                // for (let piece of this.snake) {
                // }
                this.snake = newSnake_1;
        }
    };
    __decorate([
        property(cc.Float)
    ], Board.prototype, "frameTime", void 0);
    __decorate([
        property(cc.Float)
    ], Board.prototype, "levelRatio", void 0);
    __decorate([
        property(cc.Prefab)
    ], Board.prototype, "piecePrefab", void 0);
    __decorate([
        property(cc.Node)
    ], Board.prototype, "layout", void 0);
    Board = __decorate([
        ccclass
    ], Board);
    return Board;
}(cc.Component));
exports.default = Board;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc3JjXFxzbmFrZVxcU25ha2VCb2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXlEO0FBQ3pELDJDQUFxQztBQUcvQixJQUFBLEtBQXdCLEVBQUUsQ0FBQyxVQUFVLEVBQW5DLE9BQU8sYUFBQSxFQUFFLFFBQVEsY0FBa0IsQ0FBQztBQUc1QztJQUFtQyx5QkFBWTtJQUEvQztRQUFBLHFFQXlNQztRQXhNK0IsZUFBUyxHQUFHLEdBQUcsQ0FBQztRQUNoQixnQkFBVSxHQUFHLElBQUksQ0FBQztRQUNqQixpQkFBVyxHQUFjLElBQUksQ0FBQztRQUNoQyxZQUFNLEdBQVksSUFBSSxDQUFDO1FBRTNDLGFBQU8sR0FBRyxLQUFLLENBQUM7UUFDZixjQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsYUFBTyxHQUFXLEVBQUUsQ0FBQztRQUNyQixhQUFPLEdBQVcsRUFBRSxDQUFDO1FBQ3JCLGVBQVMsR0FBVyxDQUFDLENBQUM7UUFHdEIsYUFBTyxHQUFHLDBCQUFTLENBQUMsS0FBSyxDQUFDO1FBQzNCLFdBQUssR0FBRyxDQUFDLENBQUM7UUFFVCxnQkFBVSxHQUFlLElBQUksQ0FBQzs7UUFnTHRDLHVCQUF1QjtRQUN2QiwwQkFBMEI7UUFDMUIsK0JBQStCO1FBQy9CLGlGQUFpRjtRQUNqRixnQ0FBZ0M7UUFDaEMsaUNBQWlDO1FBQ2pDLFlBQVk7UUFDWixRQUFRO1FBQ1IsSUFBSTtJQUNSLENBQUM7SUF2TEcsc0JBQU0sR0FBTjtRQUNJLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMs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Q0FBQztRQUNsRixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQywyQkFBVSxDQUFDLFVBQVUsRUFBRSwwQkFBUyxDQUFDLEtBQUssRUFBRSwwQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9FLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUFVLENBQUMsVUFBVSxFQUFFLDBCQUFTLENBQUMsRUFBRSxFQUFFLDBCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDNUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsMEJBQVMsQ0FBQyxLQUFLLENBQUM7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELHVCQUFPLEdBQVA7UUFDSSxJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7UUFDNUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxH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Qzs0QkFDOUIsTUFBTTtxQkFDYjtvQkFDRCxVQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN6QixTQUFTLEdBQUcsS0FBSyxDQUFDO2dCQUN0QixDQUFDLENBQUMsQ0FBQztnQkFDSCxrQ0FBa0M7Z0JBRWxDLElBQUk7Z0JBQ0osSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFRLENBQUM7U0FDN0I7SUFDTCxDQUFDO0lBN0xtQjtRQUFuQixRQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQzs0Q0FBeUI7SUFDeEI7UUFBbkIsUUFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUM7NkNBQTJCO0lBQ3pCO1FBQXBCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDOzhDQUF1QztJQUN4QztRQUFsQixRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQzt5Q0FBZ0M7SUFKakMsS0FBSztRQUR6QixPQUFPO09BQ2EsS0FBSyxDQXlNekI7SUFBRCxZQUFDO0NBek1ELEFBeU1DLENBek1rQyxFQUFFLENBQUMsU0FBUyxHQXlNOUM7a0JBek1vQixLQUFLIiwiZmlsZSI6IiIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRElSRUNUSU9OLCBQSUVDRV9UWVBFIH0gZnJvbSAnLi9TbmFrZUNvbnN0YW50cyc7XG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4vU25ha2VQaWVjZSc7XG5pbXBvcnQgeyBTbmFrZVNjZW5lIH0gZnJvbSAnLi9TbmFrZVNjZW5lJztcblxuY29uc3QgeyBjY2NsYXNzLCBwcm9wZXJ0eSB9ID0gY2MuX2RlY29yYXRvcjtcblxuQGNjY2xhc3NcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJvYXJkIGV4dGVuZHMgY2MuQ29tcG9uZW50IHtcbiAgICBAcHJvcGVydHkoY2MuRmxvYXQpIHByaXZhdGUgZnJhbWVUaW1lID0gMC41O1xuICAgIEBwcm9wZXJ0eShjYy5GbG9hdCkgcHJpdmF0ZSBsZXZlbFJhdGlvID0gMC4wNTtcbiAgICBAcHJvcGVydHkoY2MuUHJlZmFiKSBwcml2YXRlIHBpZWNlUHJlZmFiOiBjYy5QcmVmYWIgPSBudWxsO1xuICAgIEBwcm9wZXJ0eShjYy5Ob2RlKSBwcml2YXRlIGxheW91dDogY2MuTm9kZSA9IG51bGw7XG5cbiAgICBwdWJsaWMgaXNTdGFydCA9IGZhbHNlO1xuICAgIHByaXZhdGUgcGFzdFRpbWUgPSAwO1xuICAgIHByaXZhdGUgcm93c051bTogbnVtYmVyID0gMTY7XG4gICAgcHJpdmF0ZSBjb2xzTnVtOiBudW1iZXIgPSAxNjtcbiAgICBwcml2YXRlIGdyaWRXaWR0aDogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHBpZWNlTWFwOiBQaWVjZVtdW107XG4gICAgcHJpdmF0ZSBzbmFrZTogUGllY2VbXTtcbiAgICBwcml2YXRlIG1vdmVEaXIgPSBESVJFQ1RJT04uUklHSFQ7XG4gICAgcHVibGljIGxldmVsID0gMDtcblxuICAgIHByaXZhdGUgc25ha2VTY2VuZTogU25ha2VTY2VuZSA9IG51bGw7XG5cbiAgICBvbkxvYWQoKSB7XG4gICAgICAgIHRoaXMuZ3JpZFdpZHRoID0gdGhpcy5sYXlvdXQud2lkdGggLyB0aGlzLmNvbHNOdW07XG4gICAgICAgIHRoaXMucGllY2VNYXAgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbHNOdW07IHgrKykge1xuICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XSA9IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLnJvd3NOdW07IHkrKykge1xuICAgICAgICAgICAgICAgIGxldCBwaWVjZU5vZGUgPSBjYy5pbnN0YW50aWF0ZSh0aGlzLnBpZWNlUHJlZmFiKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxheW91dC5hZGRDaGlsZChwaWVjZU5vZGUpO1xuICAgICAgICAgICAgICAgIHBpZWNlTm9kZS53aWR0aCA9IHRoaXMuZ3JpZFdpZHRoO1xuICAgICAgICAgICAgICAgIHBpZWNlTm9kZS5oZWlnaHQgPSB0aGlzLmdyaWRXaWR0aDtcbiAgICAgICAgICAgICAgICBwaWVjZU5vZGUueCA9IHggKiB0aGlzLmdyaWRXaWR0aCArIHBpZWNlTm9kZS53aWR0aCAvIDI7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnkgPSB5ICogdGhpcy5ncmlkV2lkdGggKyBwaWVjZU5vZGUuaGVpZ2h0IC8gMjtcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldID0gcGllY2VOb2RlLmdldENvbXBvbmVudChQaWVjZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS54ID0geDtcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldLnkgPSB5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICB1cGRhdGVUaWNrKCkge1xuICAgICAgICB0aGlzLnVuc2NoZWR1bGUodGhpcy50aWNrSGFuZGxlcik7XG4gICAgICAgIGxldCB0aW1lID0gdGhpcy5mcmFtZVRpbWUgLSAodGhpcy5sZXZlbFJhdGlvICogdGhpcy5sZXZlbCk7XG4gICAgICAgIGlmICh0aW1lIDwgMC4xKSB7XG4gICAgICAgICAgICB0aW1lID0gMC4xO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2NoZWR1bGUodGhpcy50aWNrSGFuZGxlciwgdGltZSk7XG4gICAgfVxuXG4gICAgdGlja0hhbmRsZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLmlzU3RhcnQpIHtcbiAgICAgICAgICAgIHRoaXMubW92ZVNuYWtlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpbml0KHNuYWtlU2NlbmU6IFNuYWtlU2NlbmUpIHtcbiAgICAgICAgdGhpcy5zbmFrZVNjZW5lID0gc25ha2VTY2VuZTtcbiAgICB9XG5cbiAgICBzdGFydEdhbWUoKSB7XG4gICAgICAgIHRoaXMucmVzZXQoKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLmFkZEZvb2QoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzU3RhcnQgPSB0cnVlO1xuICAgICAgICB0aGlzLnVwZGF0ZVRpY2soKTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5jbGVhcigpO1xuICAgICAgICB0aGlzLnNuYWtlID0gW107XG4gICAgICAgIHRoaXMucGllY2VNYXBbOV1bOV0uaW5pdChQSUVDRV9UWVBFLlNOQUtFX0hFQUQsIERJUkVDVElPTi5SSUdIVCwgRElSRUNUSU9OLlJJR0hUKTtcbiAgICAgICAgdGhpcy5waWVjZU1hcFs4XVs5XS5pbml0KFBJRUNFX1RZUEUuU05BS0VfQk9EWSwgRElSRUNUSU9OLlJJR0hULCBESVJFQ1RJT04uUklHSFQpO1xuICAgICAgICB0aGlzLnBpZWNlTWFwWzddWzldLmluaXQoUElFQ0VfVFlQRS5TTkFLRV9CT0RZLCBESVJFQ1RJT04uUklHSFQsIERJUkVDVElPTi5VUCk7XG4gICAgICAgIHRoaXMucGllY2VNYXBbN11bOF0uaW5pdChQSUVDRV9UWVBFLlNOQUtFX1RBSUwsIERJUkVDVElPTi5VUCwgRElSRUNUSU9OLlVQKTtcbiAgICAgICAgdGhpcy5zbmFrZS5wdXNoKHRoaXMucGllY2VNYXBbOV1bOV0pO1xuICAgICAgICB0aGlzLnNuYWtlLnB1c2godGhpcy5waWVjZU1hcFs4XVs5XSk7XG4gICAgICAgIHRoaXMuc25ha2UucHVzaCh0aGlzLnBpZWNlTWFwWzddWzldKTtcbiAgICAgICAgdGhpcy5zbmFrZS5wdXNoKHRoaXMucGllY2VNYXBbN11bOF0pO1xuICAgICAgICB0aGlzLm1vdmVEaXIgPSBESVJFQ1RJT04uUklHSFQ7XG4gICAgICAgIHRoaXMubGV2ZWwgPSAwO1xuICAgIH1cblxuICAgIGFkZEZvb2QoKSB7XG4gICAgICAgIGxldCBibGFua0xpc3Q6IFBpZWNlW10gPSBbXTtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbHNOdW07IHgrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLnJvd3NOdW07IHkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBpZWNlTWFwW3hdW3ldLnR5cGUgPT09IFBJRUNFX1RZUEUuQkxBTkspIHtcbiAgICAgICAgICAgICAgICAgICAgYmxhbmtMaXN0LnB1c2godGhpcy5waWVjZU1hcFt4XVt5XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCByYW5kb21QaWVjZSA9IGJsYW5rTGlzdFsoTWF0aC5yYW5kb20oKSAqIGJsYW5rTGlzdC5sZW5ndGgpIHwgMF07XG4gICAgICAgIHJhbmRvbVBpZWNlLnR5cGUgPSBQSUVDRV9UWVBFLkZPT0Q7XG4gICAgfVxuXG4gICAgY2xlYXIoKSB7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5jb2xzTnVtOyB4KyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5yb3dzTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldLnR5cGUgPSBQSUVDRV9UWVBFLkJMQU5LO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlTGV2ZWwobGV2ZWw6IG51bWJlcikge1xuICAgICAgICBpZiAobGV2ZWwgIT09IHRoaXMubGV2ZWwpIHtcbiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSBsZXZlbDtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVGljaygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdHVyblNuYWtlKGRpcjogRElSRUNUSU9OKSB7XG4gICAgICAgIGlmICh0aGlzLnNuYWtlWzBdLm91dERpciAhPT0gLWRpcikge1xuICAgICAgICAgICAgdGhpcy5tb3ZlRGlyID0gZGlyO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbW92ZVNuYWtlKCkge1xuICAgICAgICBsZXQgaGVhZCA9IHRoaXMuc25ha2VbMF07XG4gICAgICAgIGhlYWQuaW5EaXIgPSB0aGlzLnNuYWtlWzFdLm91dERpcjtcbiAgICAgICAgaGVhZC5vdXREaXIgPSB0aGlzLm1vdmVEaXI7XG4gICAgICAgIGxldCBuZXh0UGllY2U6IFBpZWNlO1xuICAgICAgICBzd2l0Y2ggKGhlYWQub3V0RGlyKSB7XG4gICAgICAgICAgICBjYXNlIERJUkVDVElPTi5VUDpcbiAgICAgICAgICAgICAgICBpZiAoaGVhZC55ID09PSB0aGlzLnJvd3NOdW0gLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRQaWVjZSA9IHRoaXMucGllY2VNYXBbaGVhZC54XVswXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW2hlYWQueF1baGVhZC55ICsgMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBESVJFQ1RJT04uUklHSFQ6XG4gICAgICAgICAgICAgICAgaWYgKGhlYWQueCA9PT0gdGhpcy5jb2xzTnVtIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwWzBdW2hlYWQueV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFtoZWFkLnggKyAxXVtoZWFkLnldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRElSRUNUSU9OLkRPV046XG4gICAgICAgICAgICAgICAgaWYgKGhlYWQueSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW2hlYWQueF1bdGhpcy5yb3dzTnVtIC0gMV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFtoZWFkLnhdW2hlYWQueSAtIDFdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRElSRUNUSU9OLkxFRlQ6XG4gICAgICAgICAgICAgICAgaWYgKGhlYWQueCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW3RoaXMuY29sc051bSAtIDFdW2hlYWQueV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFtoZWFkLnggLSAxXVtoZWFkLnldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vdmVTbmFrZVRvUGllY2UobmV4dFBpZWNlKTtcbiAgICB9XG5cbiAgICBtb3ZlU25ha2VUb1BpZWNlKG5leHRQaWVjZTogUGllY2UpIHtcbiAgICAgICAgbGV0IGhlYWQgPSB0aGlzLnNuYWtlWzBdO1xuICAgICAgICBzd2l0Y2ggKG5leHRQaWVjZS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFBJRUNFX1RZUEUuU05BS0VfQk9EWTpcbiAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5TTkFLRV9UQUlMOlxuICAgICAgICAgICAgICAgIHRoaXMuaXNTdGFydCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuc25ha2VTY2VuZS5vdmVyR2FtZSgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQSUVDRV9UWVBFLkZPT0Q6XG4gICAgICAgICAgICAgICAgbmV4dFBpZWNlLmluaXQoUElFQ0VfVFlQRS5TTkFLRV9IRUFELCBoZWFkLm91dERpciwgaGVhZC5pbkRpcik7XG4gICAgICAgICAgICAgICAgaGVhZC5pbml0KFBJRUNFX1RZUEUuU05BS0VfQk9EWSwgaGVhZC5vdXREaXIsIGhlYWQuaW5EaXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuc25ha2UudW5zaGlmdChuZXh0UGllY2UpO1xuICAgICAgICAgICAgICAgIHRoaXMuc25ha2VTY2VuZS5vbkVhdEZvb2QoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5CTEFOSzpcbiAgICAgICAgICAgICAgICBsZXQgbmV3U25ha2UgPSBbXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNuYWtlLmZvckVhY2goKHBpZWNlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBpZWNlLnR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5TTkFLRV9IRUFEOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRQaWVjZS5pbml0KFBJRUNFX1RZUEUuU05BS0VfSEVBRCwgcGllY2Uub3V0RGlyLCBwaWVjZS5pbkRpcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFBJRUNFX1RZUEUuU05BS0VfQk9EWTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UuaW5pdChQSUVDRV9UWVBFLlNOQUtFX0JPRFksIG5leHRQaWVjZS5vdXREaXIsIHBpZWNlLm91dERpcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFBJRUNFX1RZUEUuU05BS0VfVEFJTDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UuaW5pdChQSUVDRV9UWVBFLlNOQUtFX1RBSUwsIG5leHRQaWVjZS5vdXREaXIsIHBpZWNlLm91dERpcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UudHlwZSA9IFBJRUNFX1RZUEUuQkxBTks7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbmV3U25ha2UucHVzaChuZXh0UGllY2UpO1xuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSBwaWVjZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBmb3IgKGxldCBwaWVjZSBvZiB0aGlzLnNuYWtlKSB7XG5cbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgdGhpcy5zbmFrZSA9IG5ld1NuYWtlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gdXBkYXRlKGR0OiBudW1iZXIpIHtcbiAgICAvLyAgICAgaWYgKHRoaXMuaXNTdGFydCkge1xuICAgIC8vICAgICAgICAgdGhpcy5wYXN0VGltZSArPSBkdDtcbiAgICAvLyAgICAgICAgIGlmICh0aGlzLnBhc3RUaW1lID49IHRoaXMuZnJhbWVUaW1lICogKHRoaXMubGV2ZWxSYXRpbyoqdGhpcy5sZXZlbCkpIHtcbiAgICAvLyAgICAgICAgICAgICB0aGlzLm1vdmVTbmFrZSgpO1xuICAgIC8vICAgICAgICAgICAgIHRoaXMucGFzdFRpbWUgPSAwO1xuICAgIC8vICAgICAgICAgfVxuICAgIC8vICAgICB9XG4gICAgLy8gfVxufVxuIl19