
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/src/mine/MnieBoard.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'd5dcaOV26xKp7PBWPzaeZRU', 'MnieBoard');
// src/mine/MnieBoard.ts

Object.defineProperty(exports, "__esModule", { value: true });
exports.Board = void 0;
var MinePiece_1 = require("./MinePiece");
var MineConstans_1 = require("./MineConstans");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property, executeInEditMode = _a.executeInEditMode;
var Board = /** @class */ (function (_super) {
    __extends(Board, _super);
    function Board() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.piecePrefab = null;
        _this.colNum = 9;
        _this.colSpace = 9;
        _this.pressTime = 1;
        _this.colWidth = 80;
        _this.touchingPiece = null;
        _this.touchStartTime = 0;
        _this.bombNum = 0;
        _this.flagNum = 0;
        _this.mineScene = null;
        return _this;
    }
    Board.prototype.onLoad = function () {
        var _this = this;
        this.colWidth = (this.node.width - this.colSpace * (this.colNum + 1)) / this.colNum;
        this.node.removeAllChildren();
        this.pieceMap = [];
        var _loop_1 = function (x) {
            this_1.pieceMap[x] = [];
            var _loop_2 = function (y) {
                var pieceNode = cc.instantiate(this_1.piecePrefab);
                this_1.node.addChild(pieceNode);
                pieceNode.x = x * (this_1.colWidth + this_1.colSpace) + this_1.colSpace;
                pieceNode.y = y * (this_1.colWidth + this_1.colSpace) + this_1.colSpace;
                pieceNode.width = this_1.colWidth;
                pieceNode.height = this_1.colWidth;
                this_1.pieceMap[x][y] = pieceNode.getComponent(MinePiece_1.Piece);
                this_1.pieceMap[x][y].init(x, y, MineConstans_1.PIECE_TYPE.OPEN0, MineConstans_1.PIECE_STATE.OPEN);
                pieceNode.on(cc.Node.EventType.TOUCH_START, function () {
                    _this.onPieceTouchStart(_this.pieceMap[x][y]);
                }, this_1);
                pieceNode.on(cc.Node.EventType.TOUCH_END, function () {
                    _this.onPieceTouchEnd(_this.pieceMap[x][y]);
                }, this_1);
            };
            for (var y = 0; y < this_1.colNum; y++) {
                _loop_2(y);
            }
        };
        var this_1 = this;
        for (var x = 0; x < this.colNum; x++) {
            _loop_1(x);
        }
    };
    Board.prototype.init = function (mineScene) {
        this.mineScene = mineScene;
    };
    Board.prototype.onPieceTouchStart = function (piece) {
        this.touchStartTime = new Date().getTime();
        this.touchingPiece = piece;
    };
    Board.prototype.onPieceTouchEnd = function (piece) {
        var touchEndTime = new Date().getTime();
        if (touchEndTime - this.touchStartTime > this.pressTime * 1000) {
            this.mineScene.onPressPiece(piece);
        }
        else {
            this.mineScene.onClickPiece(piece);
        }
    };
    Board.prototype.openPiece = function (piece) {
        if (piece.state === MineConstans_1.PIECE_STATE.PENDING) {
            if (piece.type === MineConstans_1.PIECE_TYPE.BOMB) {
                piece.state = MineConstans_1.PIECE_STATE.OPEN;
                this.showAll();
                this.mineScene.overGame(false);
            }
            else {
                this.showBlank(piece);
                this.judgeWin();
            }
        }
    };
    Board.prototype.flagPiece = function (piece) {
        if (piece.state === MineConstans_1.PIECE_STATE.PENDING) {
            piece.state = MineConstans_1.PIECE_STATE.FLAG;
            this.flagNum--;
            if (this.flagNum === 0) {
                var isWin = this.showRest();
                this.mineScene.overGame(isWin);
            }
        }
        else if (piece.state === MineConstans_1.PIECE_STATE.FLAG) {
            piece.state = MineConstans_1.PIECE_STATE.PENDING;
            this.flagNum++;
        }
    };
    Board.prototype.getBombNum = function () {
        return this.bombNum;
    };
    Board.prototype.getFlagNum = function () {
        return this.flagNum;
    };
    Board.prototype.getMaxLevel = function () {
        return this.colNum * this.colNum - 1;
    };
    Board.prototype.judgeWin = function () {
        var openNum = 0;
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                if (this.pieceMap[x][y].state === MineConstans_1.PIECE_STATE.OPEN) {
                    openNum++;
                }
            }
        }
        if (openNum === Math.pow(this.colNum, 2) - this.bombNum) {
            this.mineScene.overGame(true);
        }
    };
    Board.prototype.reset = function (level) {
        this.resetBlank();
        this.resetBombs(level);
        this.resetHintsAndMask();
    };
    Board.prototype.resetBlank = function () {
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                this.pieceMap[x][y].type = MineConstans_1.PIECE_TYPE.OPEN0;
            }
        }
    };
    Board.prototype.resetBombs = function (bombNum) {
        this.bombNum = bombNum;
        this.flagNum = bombNum;
        var pieceMapIndex = [];
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                pieceMapIndex.push({ x: x, y: y });
            }
        }
        for (var n = 0; n < bombNum; n++) {
            var i = Math.random() * pieceMapIndex.length | 0;
            var piecePos = pieceMapIndex[i];
            cc.log(piecePos);
            this.pieceMap[piecePos.x][piecePos.y].type = MineConstans_1.PIECE_TYPE.BOMB;
            pieceMapIndex.splice(i, 1);
        }
    };
    Board.prototype.resetHintsAndMask = function () {
        for (var x = 0; x < this.colNum; x++) {
            var _loop_3 = function (y) {
                if (this_2.pieceMap[x][y].type !== MineConstans_1.PIECE_TYPE.BOMB) {
                    var roundPieces = this_2.getRoundPieces(x, y);
                    var roundBombs_1 = 0;
                    roundPieces.forEach(function (piece) {
                        if (piece.type === MineConstans_1.PIECE_TYPE.BOMB) {
                            roundBombs_1++;
                        }
                    });
                    this_2.pieceMap[x][y].type = roundBombs_1;
                }
                this_2.pieceMap[x][y].state = MineConstans_1.PIECE_STATE.PENDING;
            };
            var this_2 = this;
            for (var y = 0; y < this.colNum; y++) {
                _loop_3(y);
            }
        }
    };
    Board.prototype.getRoundPieces = function (x, y) {
        var roundPieces = [];
        // left
        if (x >= 1) {
            roundPieces.push(this.pieceMap[x - 1][y]);
        }
        // left top
        if (x >= 1 && y <= this.colNum - 2) {
            roundPieces.push(this.pieceMap[x - 1][y + 1]);
        }
        // top
        if (y <= this.colNum - 2) {
            roundPieces.push(this.pieceMap[x][y + 1]);
        }
        // right top
        if (x <= this.colNum - 2 && y <= this.colNum - 2) {
            roundPieces.push(this.pieceMap[x + 1][y + 1]);
        }
        // right
        if (x <= this.colNum - 2) {
            roundPieces.push(this.pieceMap[x + 1][y]);
        }
        // right bottom
        if (x <= this.colNum - 2 && y >= 1) {
            roundPieces.push(this.pieceMap[x + 1][y - 1]);
        }
        // bottom
        if (y >= 1) {
            roundPieces.push(this.pieceMap[x][y - 1]);
        }
        // left bottom
        if (x >= 1 && y >= 1) {
            roundPieces.push(this.pieceMap[x - 1][y - 1]);
        }
        return roundPieces;
    };
    Board.prototype.showBlank = function (piece) {
        var testPieces = [piece];
        while (testPieces.length > 0) {
            var testPiece = testPieces.pop();
            if (testPiece.type === MineConstans_1.PIECE_TYPE.OPEN0) {
                testPiece.state = MineConstans_1.PIECE_STATE.OPEN;
                var roundPieces = this.getRoundPieces(testPiece.x, testPiece.y);
                roundPieces.forEach(function (p) {
                    if (p.state === MineConstans_1.PIECE_STATE.PENDING) {
                        testPieces.push(p);
                    }
                });
            }
            else if (testPiece.type >= MineConstans_1.PIECE_TYPE.OPEN1 && testPiece.type <= MineConstans_1.PIECE_TYPE.OPEN8) {
                testPiece.state = MineConstans_1.PIECE_STATE.OPEN;
            }
        }
    };
    // 失败后显示全部格子
    Board.prototype.showAll = function () {
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                this.pieceMap[x][y].state = MineConstans_1.PIECE_STATE.OPEN;
            }
        }
    };
    // 旗子插满后显示其他没有插旗的地方
    Board.prototype.showRest = function () {
        var isWin = true;
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                if (this.pieceMap[x][y].state === MineConstans_1.PIECE_STATE.PENDING) {
                    this.pieceMap[x][y].state = MineConstans_1.PIECE_STATE.OPEN;
                    if (this.pieceMap[x][y].type === MineConstans_1.PIECE_TYPE.BOMB) {
                        isWin = false;
                    }
                }
            }
        }
        return isWin;
    };
    __decorate([
        property(cc.Prefab)
    ], Board.prototype, "piecePrefab", void 0);
    __decorate([
        property(cc.Integer)
    ], Board.prototype, "colNum", void 0);
    __decorate([
        property(cc.Integer)
    ], Board.prototype, "colSpace", void 0);
    __decorate([
        property(cc.Float)
    ], Board.prototype, "pressTime", void 0);
    Board = __decorate([
        ccclass,
        executeInEditMode
    ], Board);
    return Board;
}(cc.Component));
exports.Board = Board;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc3JjXFxtaW5lXFxNbmllQm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx5Q0FBb0M7QUFDcEMsK0NBQXlEO0FBR25ELElBQUEsS0FBMkMsRUFBRSxDQUFDLFVBQVUsRUFBdEQsT0FBTyxhQUFBLEVBQUUsUUFBUSxjQUFBLEVBQUUsaUJBQWlCLHVCQUFrQixDQUFDO0FBSS9EO0lBQTJCLHlCQUFZO0lBQXZDO1FBQUEscUVBb1BDO1FBalBXLGlCQUFXLEdBQWMsSUFBSSxDQUFDO1FBRTlCLFlBQU0sR0FBVyxDQUFDLENBQUM7UUFFbkIsY0FBUSxHQUFXLENBQUMsQ0FBQztRQUVyQixlQUFTLEdBQVcsQ0FBQyxDQUFDO1FBRXRCLGNBQVEsR0FBVyxFQUFFLENBQUM7UUFFdEIsbUJBQWEsR0FBVSxJQUFJLENBQUM7UUFDNUIsb0JBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkIsYUFBTyxHQUFHLENBQUMsQ0FBQztRQUNaLGFBQU8sR0FBRyxDQUFDLENBQUM7UUFDWixlQUFTLEdBQWMsSUFBSSxDQUFDOztJQW1PeEMsQ0FBQztJQWpPRyxzQkFBTSxHQUFOO1FBQUEsaUJBdUJDO1FBdEJHLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDcEYsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO2dDQUNWLENBQUM7WUFDTixPQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7b0NBQ2IsQ0FBQztnQkFDTixJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLE9BQUssV0FBVyxDQUFDLENB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LENBQUMsT0FBTyxDQUFDOzJDQUNRO0lBRTdCO1FBREMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUM7NENBQ1c7SUFUckIsS0FBSztRQUZqQixPQUFPO1FBQ1AsaUJBQWlCO09BQ0wsS0FBSyxDQW9QakI7SUFBRCxZQUFDO0NBcFBELEFBb1BDLENBcFAwQixFQUFFLENBQUMsU0FBUyxHQW9QdEM7QUFwUFksc0JBQUsiLCJmaWxlIjoiIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaWVjZSB9IGZyb20gXCIuL01pbmVQaWVjZVwiO1xuaW1wb3J0IHsgUElFQ0VfVFlQRSwgUElFQ0VfU1RBVEUgfSBmcm9tIFwiLi9NaW5lQ29uc3RhbnNcIjtcbmltcG9ydCB7IE1pbmVTY2VuZSB9IGZyb20gXCIuL01pbmVTY2VuZVwiO1xuXG5jb25zdCB7IGNjY2xhc3MsIHByb3BlcnR5LCBleGVjdXRlSW5FZGl0TW9kZSB9ID0gY2MuX2RlY29yYXRvcjtcblxuQGNjY2xhc3NcbkBleGVjdXRlSW5FZGl0TW9kZVxuZXhwb3J0IGNsYXNzIEJvYXJkIGV4dGVuZHMgY2MuQ29tcG9uZW50IHtcblxuICAgIEBwcm9wZXJ0eShjYy5QcmVmYWIpXG4gICAgcHJpdmF0ZSBwaWVjZVByZWZhYjogY2MuUHJlZmFiID0gbnVsbDtcbiAgICBAcHJvcGVydHkoY2MuSW50ZWdlcilcbiAgICBwcml2YXRlIGNvbE51bTogbnVtYmVyID0gOTtcbiAgICBAcHJvcGVydHkoY2MuSW50ZWdlcilcbiAgICBwcml2YXRlIGNvbFNwYWNlOiBudW1iZXIgPSA5O1xuICAgIEBwcm9wZXJ0eShjYy5GbG9hdClcbiAgICBwcml2YXRlIHByZXNzVGltZTogbnVtYmVyID0gMTtcblxuICAgIHByaXZhdGUgY29sV2lkdGg6IG51bWJlciA9IDgwO1xuICAgIHByaXZhdGUgcGllY2VNYXA6IEFycmF5PEFycmF5PFBpZWNlPj47XG4gICAgcHJpdmF0ZSB0b3VjaGluZ1BpZWNlOiBQaWVjZSA9IG51bGw7XG4gICAgcHJpdmF0ZSB0b3VjaFN0YXJ0VGltZSA9IDA7XG4gICAgcHJpdmF0ZSBib21iTnVtID0gMDtcbiAgICBwcml2YXRlIGZsYWdOdW0gPSAwO1xuICAgIHByaXZhdGUgbWluZVNjZW5lOiBNaW5lU2NlbmUgPSBudWxsO1xuXG4gICAgb25Mb2FkKCkge1xuICAgICAgICB0aGlzLmNvbFdpZHRoID0gKHRoaXMubm9kZS53aWR0aCAtIHRoaXMuY29sU3BhY2UgKiAodGhpcy5jb2xOdW0gKyAxKSkgLyB0aGlzLmNvbE51bTtcbiAgICAgICAgdGhpcy5ub2RlLnJlbW92ZUFsbENoaWxkcmVuKCk7XG4gICAgICAgIHRoaXMucGllY2VNYXAgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbE51bTsgeCsrKSB7XG4gICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICBsZXQgcGllY2VOb2RlID0gY2MuaW5zdGFudGlhdGUodGhpcy5waWVjZVByZWZhYik7XG4gICAgICAgICAgICAgICAgdGhpcy5ub2RlLmFkZENoaWxkKHBpZWNlTm9kZSk7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnggPSB4ICogKHRoaXMuY29sV2lkdGggKyB0aGlzLmNvbFNwYWNlKSArIHRoaXMuY29sU3BhY2U7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnkgPSB5ICogKHRoaXMuY29sV2lkdGggKyB0aGlzLmNvbFNwYWNlKSArIHRoaXMuY29sU3BhY2U7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLndpZHRoID0gdGhpcy5jb2xXaWR0aDtcbiAgICAgICAgICAgICAgICBwaWVjZU5vZGUuaGVpZ2h0ID0gdGhpcy5jb2xXaWR0aDtcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldID0gcGllY2VOb2RlLmdldENvbXBvbmVudChQaWVjZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS5pbml0KHgsIHksIFBJRUNFX1RZUEUuT1BFTjAsIFBJRUNFX1NUQVRFLk9QRU4pO1xuICAgICAgICAgICAgICAgIHBpZWNlTm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9TVEFSVCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUGllY2VUb3VjaFN0YXJ0KHRoaXMucGllY2VNYXBbeF1beV0pO1xuICAgICAgICAgICAgICAgIH0sIHRoaXMpO1xuICAgICAgICAgICAgICAgIHBpZWNlTm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9FTkQsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBpZWNlVG91Y2hFbmQodGhpcy5waWVjZU1hcFt4XVt5XSk7XG4gICAgICAgICAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgaW5pdChtaW5lU2NlbmU6IE1pbmVTY2VuZSkge1xuICAgICAgICB0aGlzLm1pbmVTY2VuZSA9IG1pbmVTY2VuZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUGllY2VUb3VjaFN0YXJ0KHBpZWNlOiBQaWVjZSkge1xuICAgICAgICB0aGlzLnRvdWNoU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMudG91Y2hpbmdQaWVjZSA9IHBpZWNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25QaWVjZVRvdWNoRW5kKHBpZWNlOiBQaWVjZSkge1xuICAgICAgICBsZXQgdG91Y2hFbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIGlmICh0b3VjaEVuZFRpbWUgLSB0aGlzLnRvdWNoU3RhcnRUaW1lID4gdGhpcy5wcmVzc1RpbWUgKiAxMDAwKSB7XG4gICAgICAgICAgICB0aGlzLm1pbmVTY2VuZS5vblByZXNzUGllY2UocGllY2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5taW5lU2NlbmUub25DbGlja1BpZWNlKHBpZWNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvcGVuUGllY2UocGllY2U6IFBpZWNlKSB7XG4gICAgICAgIGlmIChwaWVjZS5zdGF0ZSA9PT0gUElFQ0VfU1RBVEUuUEVORElORykge1xuICAgICAgICAgICAgaWYgKHBpZWNlLnR5cGUgPT09IFBJRUNFX1RZUEUuQk9NQikge1xuICAgICAgICAgICAgICAgIHBpZWNlLnN0YXRlID0gUElFQ0VfU1RBVEUuT1BFTjtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbGwoKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1pbmVTY2VuZS5vdmVyR2FtZShmYWxzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0JsYW5rKHBpZWNlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmp1ZGdlV2luKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZmxhZ1BpZWNlKHBpZWNlOiBQaWVjZSkge1xuICAgICAgICBpZiAocGllY2Uuc3RhdGUgPT09IFBJRUNFX1NUQVRFLlBFTkRJTkcpIHtcbiAgICAgICAgICAgIHBpZWNlLnN0YXRlID0gUElFQ0VfU1RBVEUuRkxBRztcbiAgICAgICAgICAgIHRoaXMuZmxhZ051bS0tO1xuICAgICAgICAgICAgaWYgKHRoaXMuZmxhZ051bSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGxldCBpc1dpbiA9IHRoaXMuc2hvd1Jlc3QoKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1pbmVTY2VuZS5vdmVyR2FtZShpc1dpbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocGllY2Uuc3RhdGUgPT09IFBJRUNFX1NUQVRFLkZMQUcpIHtcbiAgICAgICAgICAgIHBpZWNlLnN0YXRlID0gUElFQ0VfU1RBVEUuUEVORElORztcbiAgICAgICAgICAgIHRoaXMuZmxhZ051bSsrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldEJvbWJOdW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJvbWJOdW07XG4gICAgfVxuXG4gICAgcHVibGljIGdldEZsYWdOdW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZsYWdOdW07XG4gICAgfVxuXG4gICAgcHVibGljIGdldE1heExldmVsKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb2xOdW0gKiB0aGlzLmNvbE51bSAtIDE7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBqdWRnZVdpbigpIHtcbiAgICAgICAgbGV0IG9wZW5OdW0gPSAwO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHRoaXMuY29sTnVtOyB4KyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5jb2xOdW07IHkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBpZWNlTWFwW3hdW3ldLnN0YXRlID09PSBQSUVDRV9TVEFURS5PUEVOKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wZW5OdW0rKztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9wZW5OdW0gPT09IHRoaXMuY29sTnVtICoqIDIgLSB0aGlzLmJvbWJOdW0pIHtcbiAgICAgICAgICAgIHRoaXMubWluZVNjZW5lLm92ZXJHYW1lKHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlc2V0KGxldmVsOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5yZXNldEJsYW5rKCk7XG4gICAgICAgIHRoaXMucmVzZXRCb21icyhsZXZlbCk7XG4gICAgICAgIHRoaXMucmVzZXRIaW50c0FuZE1hc2soKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc2V0QmxhbmsoKSB7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5jb2xOdW07IHgrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLmNvbE51bTsgeSsrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS50eXBlID0gUElFQ0VfVFlQRS5PUEVOMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcmVzZXRCb21icyhib21iTnVtOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5ib21iTnVtID0gYm9tYk51bTtcbiAgICAgICAgdGhpcy5mbGFnTnVtID0gYm9tYk51bTtcbiAgICAgICAgbGV0IHBpZWNlTWFwSW5kZXggPSBbXTtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbE51bTsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICBwaWVjZU1hcEluZGV4LnB1c2goeyB4OiB4LCB5OiB5IH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgYm9tYk51bTsgbisrKSB7XG4gICAgICAgICAgICBsZXQgaSA9IE1hdGgucmFuZG9tKCkgKiBwaWVjZU1hcEluZGV4Lmxlbmd0aCB8IDA7XG4gICAgICAgICAgICBsZXQgcGllY2VQb3MgPSBwaWVjZU1hcEluZGV4W2ldO1xuICAgICAgICAgICAgY2MubG9nKHBpZWNlUG9zKTtcbiAgICAgICAgICAgIHRoaXMucGllY2VNYXBbcGllY2VQb3MueF1bcGllY2VQb3MueV0udHlwZSA9IFBJRUNFX1RZUEUuQk9NQjtcbiAgICAgICAgICAgIHBpZWNlTWFwSW5kZXguc3BsaWNlKGksIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNldEhpbnRzQW5kTWFzaygpIHtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbE51bTsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5waWVjZU1hcFt4XVt5XS50eXBlICE9PSBQSUVDRV9UWVBFLkJPTUIpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJvdW5kUGllY2VzID0gdGhpcy5nZXRSb3VuZFBpZWNlcyh4LCB5KTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJvdW5kQm9tYnMgPSAwO1xuICAgICAgICAgICAgICAgICAgICByb3VuZFBpZWNlcy5mb3JFYWNoKChwaWVjZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlLnR5cGUgPT09IFBJRUNFX1RZUEUuQk9NQikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdW5kQm9tYnMrKztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF1beV0udHlwZSA9IHJvdW5kQm9tYnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF1beV0uc3RhdGUgPSBQSUVDRV9TVEFURS5QRU5ESU5HO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSb3VuZFBpZWNlcyh4LCB5KTogQXJyYXk8UGllY2U+IHtcbiAgICAgICAgbGV0IHJvdW5kUGllY2VzOiBQaWVjZVtdID0gW107XG4gICAgICAgIC8vIGxlZnRcbiAgICAgICAgaWYgKHggPj0gMSkge1xuICAgICAgICAgICAgcm91bmRQaWVjZXMucHVzaCh0aGlzLnBpZWNlTWFwW3ggLSAxXVt5XSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gbGVmdCB0b3BcbiAgICAgICAgaWYgKHggPj0gMSAmJiB5IDw9IHRoaXMuY29sTnVtIC0gMikge1xuICAgICAgICAgICAgcm91bmRQaWVjZXMucHVzaCh0aGlzLnBpZWNlTWFwW3ggLSAxXVt5ICsgMV0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIHRvcFxuICAgICAgICBpZiAoeSA8PSB0aGlzLmNvbE51bSAtIDIpIHtcbiAgICAgICAgICAgIHJvdW5kUGllY2VzLnB1c2godGhpcy5waWVjZU1hcFt4XVt5ICsgMV0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIHJpZ2h0IHRvcFxuICAgICAgICBpZiAoeCA8PSB0aGlzLmNvbE51bSAtIDIgJiYgeSA8PSB0aGlzLmNvbE51bSAtIDIpIHtcbiAgICAgICAgICAgIHJvdW5kUGllY2VzLnB1c2godGhpcy5waWVjZU1hcFt4ICsgMV1beSArIDFdKTtcbiAgICAgICAgfVxuICAgICAgICAvLyByaWdodFxuICAgICAgICBpZiAoeCA8PSB0aGlzLmNvbE51bSAtIDIpIHtcbiAgICAgICAgICAgIHJvdW5kUGllY2VzLnB1c2godGhpcy5waWVjZU1hcFt4ICsgMV1beV0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIHJpZ2h0IGJvdHRvbVxuICAgICAgICBpZiAoeCA8PSB0aGlzLmNvbE51bSAtIDIgJiYgeSA+PSAxKSB7XG4gICAgICAgICAgICByb3VuZFBpZWNlcy5wdXNoKHRoaXMucGllY2VNYXBbeCArIDFdW3kgLSAxXSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gYm90dG9tXG4gICAgICAgIGlmICh5ID49IDEpIHtcbiAgICAgICAgICAgIHJvdW5kUGllY2VzLnB1c2godGhpcy5waWVjZU1hcFt4XVt5IC0gMV0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIGxlZnQgYm90dG9tXG4gICAgICAgIGlmICh4ID49IDEgJiYgeSA+PSAxKSB7XG4gICAgICAgICAgICByb3VuZFBpZWNlcy5wdXNoKHRoaXMucGllY2VNYXBbeCAtIDFdW3kgLSAxXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJvdW5kUGllY2VzO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2hvd0JsYW5rKHBpZWNlOiBQaWVjZSkge1xuICAgICAgICBsZXQgdGVzdFBpZWNlczogQXJyYXk8UGllY2U+ID0gW3BpZWNlXTtcbiAgICAgICAgd2hpbGUgKHRlc3RQaWVjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IHRlc3RQaWVjZSA9IHRlc3RQaWVjZXMucG9wKCk7XG4gICAgICAgICAgICBpZiAodGVzdFBpZWNlLnR5cGUgPT09IFBJRUNFX1RZUEUuT1BFTjApIHtcbiAgICAgICAgICAgICAgICB0ZXN0UGllY2Uuc3RhdGUgPSBQSUVDRV9TVEFURS5PUEVOO1xuICAgICAgICAgICAgICAgIGxldCByb3VuZFBpZWNlcyA9IHRoaXMuZ2V0Um91bmRQaWVjZXModGVzdFBpZWNlLngsIHRlc3RQaWVjZS55KTtcbiAgICAgICAgICAgICAgICByb3VuZFBpZWNlcy5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0ZSA9PT0gUElFQ0VfU1RBVEUuUEVORElORykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVzdFBpZWNlcy5wdXNoKHApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRlc3RQaWVjZS50eXBlID49IFBJRUNFX1RZUEUuT1BFTjEgJiYgdGVzdFBpZWNlLnR5cGUgPD0gUElFQ0VfVFlQRS5PUEVOOCkge1xuICAgICAgICAgICAgICAgIHRlc3RQaWVjZS5zdGF0ZSA9IFBJRUNFX1NUQVRFLk9QRU47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDlpLHotKXlkI7mmL7npLrlhajpg6jmoLzlrZBcbiAgICBwcml2YXRlIHNob3dBbGwoKSB7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5jb2xOdW07IHgrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLmNvbE51bTsgeSsrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS5zdGF0ZSA9IFBJRUNFX1NUQVRFLk9QRU47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDml5flrZDmj5Lmu6HlkI7mmL7npLrlhbbku5bmsqHmnInmj5Lml5fnmoTlnLDmlrlcbiAgICBwcml2YXRlIHNob3dSZXN0KCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaXNXaW4gPSB0cnVlO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHRoaXMuY29sTnVtOyB4KyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5jb2xOdW07IHkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBpZWNlTWFwW3hdW3ldLnN0YXRlID09PSBQSUVDRV9TVEFURS5QRU5ESU5HKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF1beV0uc3RhdGUgPSBQSUVDRV9TVEFURS5PUEVOO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5waWVjZU1hcFt4XVt5XS50eXBlID09PSBQSUVDRV9UWVBFLkJPTUIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzV2luID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlzV2luO1xuICAgIH1cbn0iXX0=