
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/src/link/LinkBoard.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '2905cdKUxxBqrUAlqcuwUGI', 'LinkBoard');
// src/link/LinkBoard.ts

Object.defineProperty(exports, "__esModule", { value: true });
exports.LinkBoard = void 0;
var LinkPiece_1 = require("./LinkPiece");
var LinkConstants_1 = require("./LinkConstants");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property, executeInEditMode = _a.executeInEditMode;
var LinkBoard = /** @class */ (function (_super) {
    __extends(LinkBoard, _super);
    function LinkBoard() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.piecePrefab = null;
        _this.colNum = 10;
        _this.colSpace = 5;
        _this.pen = null;
        _this.pictureNum = 8;
        _this.colWidth = 0;
        _this.lastPiece = null;
        _this.linkScene = null;
        return _this;
    }
    LinkBoard.prototype.onLoad = function () {
        this.colWidth = (this.node.width - this.colSpace * (this.colNum + 1)) / this.colNum;
        this.node.removeAllChildren();
        this.pieceMap = [];
        for (var x = 0; x < this.colNum; x++) {
            this.pieceMap[x] = [];
            for (var y = 0; y < this.colNum; y++) {
                var pieceNode = cc.instantiate(this.piecePrefab);
                this.node.addChild(pieceNode);
                pieceNode.x = x * (this.colWidth + this.colSpace) + this.colSpace;
                pieceNode.y = y * (this.colWidth + this.colSpace) + this.colSpace;
                pieceNode.width = this.colWidth;
                pieceNode.height = this.colWidth;
                var piece = pieceNode.getComponent(LinkPiece_1.Piece);
                this.pieceMap[x][y] = piece;
                // 最外一圈当作墙
                this.pieceMap[x][y].init(x, y, 0);
                this.addTouchEvent(piece);
            }
        }
    };
    LinkBoard.prototype.init = function (linkScene) {
        this.linkScene = linkScene;
    };
    LinkBoard.prototype.reset = function () {
        this.shuffle();
    };
    LinkBoard.prototype.addTouchEvent = function (piece) {
        var _this = this;
        piece.node.on(cc.Node.EventType.TOUCH_END, function () {
            if (piece.type === 0) {
                return;
            }
            if (piece.state === LinkConstants_1.PIECE_STATE.IDLE) {
                if (_this.lastPiece === null) {
                    piece.setState(LinkConstants_1.PIECE_STATE.PRESS);
                    _this.lastPiece = piece;
                }
                else {
                    if (_this.link(_this.lastPiece, piece)) {
                        _this.lastPiece = null;
                        _this.judgeWin();
                    }
                    else {
                        _this.lastPiece.setState(LinkConstants_1.PIECE_STATE.IDLE);
                        piece.setState(LinkConstants_1.PIECE_STATE.PRESS);
                        _this.lastPiece = piece;
                    }
                }
            }
            else if (piece.state === LinkConstants_1.PIECE_STATE.PRESS) {
                piece.setState(LinkConstants_1.PIECE_STATE.IDLE);
                _this.lastPiece = null;
            }
        }, this);
    };
    LinkBoard.prototype.canDirectLink = function (piece1, piece2) {
        if (piece1.x === piece2.x) {
            var minY = Math.min(piece1.y, piece2.y);
            var maxY = Math.max(piece1.y, piece2.y);
            for (var y = minY + 1; y < maxY; y++) {
                if (this.pieceMap[piece1.x][y].type !== 0) {
                    return false;
                }
            }
            return true;
        }
        if (piece1.y === piece2.y) {
            var minX = Math.min(piece1.x, piece2.x);
            var maxX = Math.max(piece1.x, piece2.x);
            for (var x = minX + 1; x < maxX; x++) {
                if (this.pieceMap[x][piece1.y].type !== 0) {
                    return false;
                }
            }
            return true;
        }
        return false;
    };
    LinkBoard.prototype.findCorner = function (piece1, piece2) {
        var c1, c2;
        // 0折
        if (this.canDirectLink(piece1, piece2)) {
            return [true, []];
        }
        // 1折 找一个点
        c1 = this.pieceMap[piece1.x][piece2.y];
        if (c1.type === 0 && this.canDirectLink(c1, piece1) && this.canDirectLink(c1, piece2)) {
            return [true, [c1]];
        }
        c1 = this.pieceMap[piece2.x][piece1.y];
        if (c1.type === 0 && this.canDirectLink(c1, piece1) && this.canDirectLink(c1, piece2)) {
            return [true, [c1]];
        }
        // 2折 找一条线
        for (var x = 0; x < this.colNum; x++) {
            if (x === piece1.x || x === piece2.x) {
                continue;
            }
            c1 = this.pieceMap[x][piece1.y];
            c2 = this.pieceMap[x][piece2.y];
            if (c1.type === 0 && c2.type === 0
                && this.canDirectLink(c1, c2)
                && this.canDirectLink(c1, piece1)
                && this.canDirectLink(c2, piece2)) {
                return [true, [c1, c2]];
            }
        }
        for (var y = 0; y < this.colNum; y++) {
            if (y === piece1.y || y === piece2.y) {
                continue;
            }
            c1 = this.pieceMap[piece1.x][y];
            c2 = this.pieceMap[piece2.x][y];
            if (c1.type === 0 && c2.type === 0
                && this.canDirectLink(c1, c2)
                && this.canDirectLink(c1, piece1)
                && this.canDirectLink(c2, piece2)) {
                return [true, [c1, c2]];
            }
        }
        return [false, null];
    };
    LinkBoard.prototype.link = function (piece1, piece2) {
        if (piece1.type !== piece2.type) {
            return false;
        }
        var _a = this.findCorner(piece1, piece2), pass = _a[0], corners = _a[1];
        if (pass) {
            this.drawLine([piece1].concat(corners).concat(piece2));
            piece1.setType(0);
            piece2.setType(0);
            return true;
        }
        else {
            return false;
        }
    };
    LinkBoard.prototype.drawLine = function (path) {
        var _this = this;
        var pos = this.getPieceCenterPosition(path[0]);
        this.pen.moveTo(pos.x, pos.y);
        for (var i = 1; i < path.length; i++) {
            pos = this.getPieceCenterPosition(path[i]);
            this.pen.lineTo(pos.x, pos.y);
        }
        this.pen.stroke();
        setTimeout(function () {
            _this.clearLine();
        }, 500);
    };
    LinkBoard.prototype.clearLine = function () {
        this.pen.clear();
    };
    LinkBoard.prototype.getPieceCenterPosition = function (piece) {
        var x = piece.x * (this.colWidth + this.colSpace) + this.colSpace + this.colWidth / 2;
        var y = piece.y * (this.colWidth + this.colSpace) + this.colSpace + this.colWidth / 2;
        return cc.v2(x, y);
    };
    LinkBoard.prototype.shuffle = function () {
        var pictureList = [];
        for (var i = 1; i <= 78; i++) {
            pictureList.push(i);
        }
        var pending = [];
        for (var x = 1; x < this.colNum - 1; x++) {
            for (var y = 1; y < this.colNum - 1; y++) {
                pending.push(this.pieceMap[x][y]);
            }
        }
        var p1, p2;
        var pieceNum = Math.pow((this.colNum - 2), 2);
        var rem = pieceNum / 2 % this.pictureNum; // 余数，重复的几对
        var coupleNum = (pieceNum / 2 - rem) / this.pictureNum; // 相同的图片有多少对
        for (var i = 0; i < this.pictureNum; i++) {
            var picture = this.randomPop(pictureList);
            for (var j = 0; j < coupleNum * 2; j++) {
                var p = this.randomPop(pending);
                p.setType(picture);
                p.setState(LinkConstants_1.PIECE_STATE.IDLE);
            }
            if (i < rem) {
                for (var k = 0; k < 2; k++) {
                    var p = this.randomPop(pending);
                    p.setType(picture);
                    p.setState(LinkConstants_1.PIECE_STATE.IDLE);
                }
            }
        }
    };
    LinkBoard.prototype.randomPop = function (arr) {
        var n = Math.random() * arr.length | 0;
        return arr.splice(n, 1)[0];
    };
    LinkBoard.prototype.judgeWin = function () {
        for (var x = 0; x < this.colNum; x++) {
            for (var y = 0; y < this.colNum; y++) {
                if (this.pieceMap[x][y].type !== 0) {
                    return false;
                }
            }
        }
        this.linkScene.overGame();
        return true;
    };
    __decorate([
        property(cc.Prefab)
    ], LinkBoard.prototype, "piecePrefab", void 0);
    __decorate([
        property(cc.Integer)
    ], LinkBoard.prototype, "colNum", void 0);
    __decorate([
        property(cc.Integer)
    ], LinkBoard.prototype, "colSpace", void 0);
    __decorate([
        property(cc.Graphics)
    ], LinkBoard.prototype, "pen", void 0);
    __decorate([
        property(cc.Integer)
    ], LinkBoard.prototype, "pictureNum", void 0);
    LinkBoard = __decorate([
        ccclass,
        executeInEditMode
    ], LinkBoard);
    return LinkBoard;
}(cc.Component));
exports.LinkBoard = LinkBoard;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc3JjXFxsaW5rXFxMaW5rQm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx5Q0FBb0M7QUFFcEMsaURBQThDO0FBRXhDLElBQUEsS0FBMkMsRUFBRSxDQUFDLFVBQVUsRUFBdEQsT0FBTyxhQUFBLEVBQUUsUUFBUSxjQUFBLEVBQUUsaUJBQWlCLHVCQUFrQixDQUFDO0FBSS9EO0lBQStCLDZCQUFZO0lBQTNDO1FBQUEscUVBdU9DO1FBcE9XLGlCQUFXLEdBQWMsSUFBSSxDQUFDO1FBRTlCLFlBQU0sR0FBVyxFQUFFLENBQUM7UUFFcEIsY0FBUSxHQUFXLENBQUMsQ0FBQztRQUVyQixTQUFHLEdBQWdCLElBQUksQ0FBQztRQUV4QixnQkFBVSxHQUFXLENBQUMsQ0FBQztRQUV2QixjQUFRLEdBQVcsQ0FBQyxDQUFDO1FBRXJCLGVBQVMsR0FBVSxJQUFJLENBQUM7UUFFeEIsZUFBUyxHQUFjLElBQUksQ0FBQzs7SUFzTnhDLENBQUM7SUFwTkcsMEJBQU0sR0FBTjtRQUNJLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDcEYsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMs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UUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFsT0Q7UUFEQyxRQUFRLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQztrREFDa0I7SUFFdEM7UUFEQyxRQUFRLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQzs2Q0FDTztJQUU1QjtRQURDLFFBQVEsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDOytDQUNRO0lBRTdCO1FBREMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUM7MENBQ1U7SUFFaEM7UUFEQyxRQUFRLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQztpREFDVTtJQVh0QixTQUFTO1FBRnJCLE9BQU87UUFDUCxpQkFBaUI7T0FDTCxTQUFTLENBdU9yQjtJQUFELGdCQUFDO0NBdk9ELEFBdU9DLENBdk84QixFQUFFLENBQUMsU0FBUyxHQXVPMUM7QUF2T1ksOEJBQVMiLCJmaWxlIjoiIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaWVjZSB9IGZyb20gXCIuL0xpbmtQaWVjZVwiO1xuaW1wb3J0IHsgTGlua1NjZW5lIH0gZnJvbSBcIi4vTGlua1NjZW5lXCI7XG5pbXBvcnQgeyBQSUVDRV9TVEFURSB9IGZyb20gXCIuL0xpbmtDb25zdGFudHNcIjtcblxuY29uc3QgeyBjY2NsYXNzLCBwcm9wZXJ0eSwgZXhlY3V0ZUluRWRpdE1vZGUgfSA9IGNjLl9kZWNvcmF0b3I7XG5cbkBjY2NsYXNzXG5AZXhlY3V0ZUluRWRpdE1vZGVcbmV4cG9ydCBjbGFzcyBMaW5rQm9hcmQgZXh0ZW5kcyBjYy5Db21wb25lbnQge1xuXG4gICAgQHByb3BlcnR5KGNjLlByZWZhYilcbiAgICBwcml2YXRlIHBpZWNlUHJlZmFiOiBjYy5QcmVmYWIgPSBudWxsO1xuICAgIEBwcm9wZXJ0eShjYy5JbnRlZ2VyKVxuICAgIHByaXZhdGUgY29sTnVtOiBudW1iZXIgPSAxMDtcbiAgICBAcHJvcGVydHkoY2MuSW50ZWdlcilcbiAgICBwcml2YXRlIGNvbFNwYWNlOiBudW1iZXIgPSA1O1xuICAgIEBwcm9wZXJ0eShjYy5HcmFwaGljcylcbiAgICBwcml2YXRlIHBlbjogY2MuR3JhcGhpY3MgPSBudWxsO1xuICAgIEBwcm9wZXJ0eShjYy5JbnRlZ2VyKVxuICAgIHByaXZhdGUgcGljdHVyZU51bTogbnVtYmVyID0gODtcblxuICAgIHByaXZhdGUgY29sV2lkdGg6IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSBwaWVjZU1hcDogQXJyYXk8QXJyYXk8UGllY2U+PjtcbiAgICBwcml2YXRlIGxhc3RQaWVjZTogUGllY2UgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBsaW5rU2NlbmU6IExpbmtTY2VuZSA9IG51bGw7XG4gICAgXG4gICAgb25Mb2FkKCkge1xuICAgICAgICB0aGlzLmNvbFdpZHRoID0gKHRoaXMubm9kZS53aWR0aCAtIHRoaXMuY29sU3BhY2UgKiAodGhpcy5jb2xOdW0gKyAxKSkgLyB0aGlzLmNvbE51bTtcbiAgICAgICAgdGhpcy5ub2RlLnJlbW92ZUFsbENoaWxkcmVuKCk7XG4gICAgICAgIHRoaXMucGllY2VNYXAgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbE51bTsgeCsrKSB7XG4gICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICBsZXQgcGllY2VOb2RlID0gY2MuaW5zdGFudGlhdGUodGhpcy5waWVjZVByZWZhYik7XG4gICAgICAgICAgICAgICAgdGhpcy5ub2RlLmFkZENoaWxkKHBpZWNlTm9kZSk7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnggPSB4ICogKHRoaXMuY29sV2lkdGggKyB0aGlzLmNvbFNwYWNlKSArIHRoaXMuY29sU3BhY2U7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnkgPSB5ICogKHRoaXMuY29sV2lkdGggKyB0aGlzLmNvbFNwYWNlKSArIHRoaXMuY29sU3BhY2U7XG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLndpZHRoID0gdGhpcy5jb2xXaWR0aDtcbiAgICAgICAgICAgICAgICBwaWVjZU5vZGUuaGVpZ2h0ID0gdGhpcy5jb2xXaWR0aDtcbiAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSBwaWVjZU5vZGUuZ2V0Q29tcG9uZW50KFBpZWNlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldID0gcGllY2U7XG4gICAgICAgICAgICAgICAgLy8g5pyA5aSW5LiA5ZyI5b2T5L2c5aKZXG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS5pbml0KHgsIHksIDApO1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkVG91Y2hFdmVudChwaWVjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpbml0KGxpbmtTY2VuZTogTGlua1NjZW5lKSB7XG4gICAgICAgIHRoaXMubGlua1NjZW5lID0gbGlua1NjZW5lO1xuICAgIH1cbiAgICBcbiAgICBwdWJsaWMgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMuc2h1ZmZsZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRkVG91Y2hFdmVudChwaWVjZTogUGllY2UpIHtcbiAgICAgICAgcGllY2Uubm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9FTkQsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChwaWVjZS50eXBlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBpZWNlLnN0YXRlID09PSBQSUVDRV9TVEFURS5JRExFKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubGFzdFBpZWNlID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnNldFN0YXRlKFBJRUNFX1NUQVRFLlBSRVNTKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0UGllY2UgPSBwaWVjZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5saW5rKHRoaXMubGFzdFBpZWNlLCBwaWVjZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFBpZWNlID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuanVkZ2VXaW4oKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFBpZWNlLnNldFN0YXRlKFBJRUNFX1NUQVRFLklETEUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGllY2Uuc2V0U3RhdGUoUElFQ0VfU1RBVEUuUFJFU1MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0UGllY2UgPSBwaWVjZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAocGllY2Uuc3RhdGUgPT09IFBJRUNFX1NUQVRFLlBSRVNTKSB7XG4gICAgICAgICAgICAgICAgcGllY2Uuc2V0U3RhdGUoUElFQ0VfU1RBVEUuSURMRSk7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0UGllY2UgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aGlzKTtcbiAgICB9XG5cbiAgICBjYW5EaXJlY3RMaW5rKHBpZWNlMTogUGllY2UsIHBpZWNlMjogUGllY2UpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHBpZWNlMS54ID09PSBwaWVjZTIueCkge1xuICAgICAgICAgICAgbGV0IG1pblkgPSBNYXRoLm1pbihwaWVjZTEueSwgcGllY2UyLnkpO1xuICAgICAgICAgICAgbGV0IG1heFkgPSBNYXRoLm1heChwaWVjZTEueSwgcGllY2UyLnkpO1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IG1pblkgKyAxOyB5IDwgbWF4WTsgeSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGllY2VNYXBbcGllY2UxLnhdW3ldLnR5cGUgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBpZWNlMS55ID09PSBwaWVjZTIueSkge1xuICAgICAgICAgICAgbGV0IG1pblggPSBNYXRoLm1pbihwaWVjZTEueCwgcGllY2UyLngpO1xuICAgICAgICAgICAgbGV0IG1heFggPSBNYXRoLm1heChwaWVjZTEueCwgcGllY2UyLngpO1xuICAgICAgICAgICAgZm9yIChsZXQgeCA9IG1pblggKyAxOyB4IDwgbWF4WDsgeCsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGllY2VNYXBbeF1bcGllY2UxLnldLnR5cGUgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGZpbmRDb3JuZXIocGllY2UxOiBQaWVjZSwgcGllY2UyOiBQaWVjZSk6IFtib29sZWFuLCBBcnJheTxQaWVjZT5dIHtcbiAgICAgICAgbGV0IGMxOiBQaWVjZSwgYzI6IFBpZWNlO1xuICAgICAgICAvLyAw5oqYXG4gICAgICAgIGlmICh0aGlzLmNhbkRpcmVjdExpbmsocGllY2UxLCBwaWVjZTIpKSB7XG4gICAgICAgICAgICByZXR1cm4gW3RydWUsIFtdXTtcbiAgICAgICAgfVxuICAgICAgICAvLyAx5oqYIOaJvuS4gOS4queCuVxuICAgICAgICBjMSA9IHRoaXMucGllY2VNYXBbcGllY2UxLnhdW3BpZWNlMi55XTtcbiAgICAgICAgaWYgKGMxLnR5cGUgPT09IDAgJiYgdGhpcy5jYW5EaXJlY3RMaW5rKGMxLCBwaWVjZTEpICYmIHRoaXMuY2FuRGlyZWN0TGluayhjMSwgcGllY2UyKSkge1xuICAgICAgICAgICAgcmV0dXJuIFt0cnVlLCBbYzFdXTtcbiAgICAgICAgfVxuICAgICAgICBjMSA9IHRoaXMucGllY2VNYXBbcGllY2UyLnhdW3BpZWNlMS55XTtcbiAgICAgICAgaWYgKGMxLnR5cGUgPT09IDAgJiYgdGhpcy5jYW5EaXJlY3RMaW5rKGMxLCBwaWVjZTEpICYmIHRoaXMuY2FuRGlyZWN0TGluayhjMSwgcGllY2UyKSkge1xuICAgICAgICAgICAgcmV0dXJuIFt0cnVlLCBbYzFdXTtcbiAgICAgICAgfVxuICAgICAgICAvLyAy5oqYIOaJvuS4gOadoee6v1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHRoaXMuY29sTnVtOyB4KyspIHtcbiAgICAgICAgICAgIGlmICh4ID09PSBwaWVjZTEueCB8fCB4ID09PSBwaWVjZTIueCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYzEgPSB0aGlzLnBpZWNlTWFwW3hdW3BpZWNlMS55XTtcbiAgICAgICAgICAgIGMyID0gdGhpcy5waWVjZU1hcFt4XVtwaWVjZTIueV07XG4gICAgICAgICAgICBpZiAoYzEudHlwZSA9PT0gMCAmJiBjMi50eXBlID09PSAwXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5jYW5EaXJlY3RMaW5rKGMxLCBjMilcbiAgICAgICAgICAgICAgICAmJiB0aGlzLmNhbkRpcmVjdExpbmsoYzEsIHBpZWNlMSlcbiAgICAgICAgICAgICAgICAmJiB0aGlzLmNhbkRpcmVjdExpbmsoYzIsIHBpZWNlMikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW3RydWUsIFtjMSwgYzJdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgIGlmICh5ID09PSBwaWVjZTEueSB8fCB5ID09PSBwaWVjZTIueSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYzEgPSB0aGlzLnBpZWNlTWFwW3BpZWNlMS54XVt5XTtcbiAgICAgICAgICAgIGMyID0gdGhpcy5waWVjZU1hcFtwaWVjZTIueF1beV07XG4gICAgICAgICAgICBpZiAoYzEudHlwZSA9PT0gMCAmJiBjMi50eXBlID09PSAwXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5jYW5EaXJlY3RMaW5rKGMxLCBjMilcbiAgICAgICAgICAgICAgICAmJiB0aGlzLmNhbkRpcmVjdExpbmsoYzEsIHBpZWNlMSlcbiAgICAgICAgICAgICAgICAmJiB0aGlzLmNhbkRpcmVjdExpbmsoYzIsIHBpZWNlMikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW3RydWUsIFtjMSwgYzJdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW2ZhbHNlLCBudWxsXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxpbmsocGllY2UxOiBQaWVjZSwgcGllY2UyOiBQaWVjZSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAocGllY2UxLnR5cGUgIT09IHBpZWNlMi50eXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IFtwYXNzLCBjb3JuZXJzXSA9IHRoaXMuZmluZENvcm5lcihwaWVjZTEsIHBpZWNlMik7XG4gICAgICAgIGlmIChwYXNzKSB7XG4gICAgICAgICAgICB0aGlzLmRyYXdMaW5lKFtwaWVjZTFdLmNvbmNhdChjb3JuZXJzKS5jb25jYXQocGllY2UyKSk7XG4gICAgICAgICAgICBwaWVjZTEuc2V0VHlwZSgwKTtcbiAgICAgICAgICAgIHBpZWNlMi5zZXRUeXBlKDApO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRyYXdMaW5lKHBhdGg6IFBpZWNlW10pIHtcbiAgICAgICAgbGV0IHBvcyA9IHRoaXMuZ2V0UGllY2VDZW50ZXJQb3NpdGlvbihwYXRoWzBdKTtcbiAgICAgICAgdGhpcy5wZW4ubW92ZVRvKHBvcy54LCBwb3MueSk7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgcG9zID0gdGhpcy5nZXRQaWVjZUNlbnRlclBvc2l0aW9uKHBhdGhbaV0pO1xuICAgICAgICAgICAgdGhpcy5wZW4ubGluZVRvKHBvcy54LCBwb3MueSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wZW4uc3Ryb2tlKCk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbGVhckxpbmUoKTtcbiAgICAgICAgfSwgNTAwKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFyTGluZSgpIHtcbiAgICAgICAgdGhpcy5wZW4uY2xlYXIoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFBpZWNlQ2VudGVyUG9zaXRpb24ocGllY2U6IFBpZWNlKTogY2MuVmVjMiB7XG4gICAgICAgIGxldCB4ID0gcGllY2UueCAqICh0aGlzLmNvbFdpZHRoICsgdGhpcy5jb2xTcGFjZSkgKyB0aGlzLmNvbFNwYWNlICsgdGhpcy5jb2xXaWR0aCAvIDI7XG4gICAgICAgIGxldCB5ID0gcGllY2UueSAqICh0aGlzLmNvbFdpZHRoICsgdGhpcy5jb2xTcGFjZSkgKyB0aGlzLmNvbFNwYWNlICsgdGhpcy5jb2xXaWR0aCAvIDI7XG4gICAgICAgIHJldHVybiBjYy52Mih4LCB5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNodWZmbGUoKSB7XG4gICAgICAgIGxldCBwaWN0dXJlTGlzdCA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSA3ODsgaSsrKSB7XG4gICAgICAgICAgICBwaWN0dXJlTGlzdC5wdXNoKGkpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBwZW5kaW5nID0gW107XG4gICAgICAgIGZvciAobGV0IHggPSAxOyB4IDwgdGhpcy5jb2xOdW0gLSAxOyB4KyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAxOyB5IDwgdGhpcy5jb2xOdW0gLSAxOyB5KyspIHtcbiAgICAgICAgICAgICAgICBwZW5kaW5nLnB1c2godGhpcy5waWVjZU1hcFt4XVt5XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHAxLCBwMjtcbiAgICAgICAgbGV0IHBpZWNlTnVtID0gKHRoaXMuY29sTnVtIC0gMikgKiogMjtcbiAgICAgICAgbGV0IHJlbSA9IHBpZWNlTnVtIC8gMiAlIHRoaXMucGljdHVyZU51bTsgLy8g5L2Z5pWw77yM6YeN5aSN55qE5Yeg5a+5XG4gICAgICAgIGxldCBjb3VwbGVOdW0gPSAocGllY2VOdW0gLyAyIC0gcmVtKSAvIHRoaXMucGljdHVyZU51bTsgLy8g55u45ZCM55qE5Zu+54mH5pyJ5aSa5bCR5a+5XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5waWN0dXJlTnVtOyBpKyspIHtcbiAgICAgICAgICAgIGxldCBwaWN0dXJlID0gdGhpcy5yYW5kb21Qb3AocGljdHVyZUxpc3QpO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VwbGVOdW0gKiAyOyBqKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHRoaXMucmFuZG9tUG9wKHBlbmRpbmcpO1xuICAgICAgICAgICAgICAgIHAuc2V0VHlwZShwaWN0dXJlKTtcbiAgICAgICAgICAgICAgICBwLnNldFN0YXRlKFBJRUNFX1NUQVRFLklETEUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGkgPCByZW0pIHtcbiAgICAgICAgICAgICAgICBmb3IobGV0IGsgPSAwOyBrIDwgMjsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwID0gdGhpcy5yYW5kb21Qb3AocGVuZGluZyk7XG4gICAgICAgICAgICAgICAgICAgIHAuc2V0VHlwZShwaWN0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgcC5zZXRTdGF0ZShQSUVDRV9TVEFURS5JRExFKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJhbmRvbVBvcChhcnI6IEFycmF5PGFueT4pIHtcbiAgICAgICAgbGV0IG4gPSBNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCB8IDA7XG4gICAgICAgIHJldHVybiBhcnIuc3BsaWNlKG4sIDEpWzBdO1xuICAgIH1cblxuICAgIHB1YmxpYyBqdWRnZVdpbigpOiBib29sZWFuIHtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbE51bTsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuY29sTnVtOyB5KyspIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5waWVjZU1hcFt4XVt5XS50eXBlICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saW5rU2NlbmUub3ZlckdhbWUoKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG59Il19