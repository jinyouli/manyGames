{"version":3,"sources":["assets\\src\\link\\LinkBoard.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Piece } from \"./LinkPiece\";\nimport { LinkScene } from \"./LinkScene\";\nimport { PIECE_STATE } from \"./LinkConstants\";\n\nconst { ccclass, property, executeInEditMode } = cc._decorator;\n\n@ccclass\n@executeInEditMode\nexport class LinkBoard extends cc.Component {\n\n    @property(cc.Prefab)\n    private piecePrefab: cc.Prefab = null;\n    @property(cc.Integer)\n    private colNum: number = 10;\n    @property(cc.Integer)\n    private colSpace: number = 5;\n    @property(cc.Graphics)\n    private pen: cc.Graphics = null;\n    @property(cc.Integer)\n    private pictureNum: number = 8;\n\n    private colWidth: number = 0;\n    private pieceMap: Array<Array<Piece>>;\n    private lastPiece: Piece = null;\n\n    private linkScene: LinkScene = null;\n    \n    onLoad() {\n        this.colWidth = (this.node.width - this.colSpace * (this.colNum + 1)) / this.colNum;\n        this.node.removeAllChildren();\n        this.pieceMap = [];\n        for (let x = 0; x < this.colNum; x++) {\n            this.pieceMap[x] = [];\n            for (let y = 0; y < this.colNum; y++) {\n                let pieceNode = cc.instantiate(this.piecePrefab);\n                this.node.addChild(pieceNode);\n                pieceNode.x = x * (this.colWidth + this.colSpace) + this.colSpace;\n                pieceNode.y = y * (this.colWidth + this.colSpace) + this.colSpace;\n                pieceNode.width = this.colWidth;\n                pieceNode.height = this.colWidth;\n                let piece = pieceNode.getComponent(Piece);\n                this.pieceMap[x][y] = piece;\n                // 最外一圈当作墙\n                this.pieceMap[x][y].init(x, y, 0);\n                this.addTouchEvent(piece);\n            }\n        }\n    }\n\n    init(linkScene: LinkScene) {\n        this.linkScene = linkScene;\n    }\n    \n    public reset() {\n        this.shuffle();\n    }\n\n    private addTouchEvent(piece: Piece) {\n        piece.node.on(cc.Node.EventType.TOUCH_END, () => {\n            if (piece.type === 0) {\n                return;\n            }\n            if (piece.state === PIECE_STATE.IDLE) {\n                if (this.lastPiece === null) {\n                    piece.setState(PIECE_STATE.PRESS);\n                    this.lastPiece = piece;\n                } else {\n                    if (this.link(this.lastPiece, piece)) {\n                        this.lastPiece = null;\n                        this.judgeWin();\n                    } else {\n                        this.lastPiece.setState(PIECE_STATE.IDLE);\n                        piece.setState(PIECE_STATE.PRESS);\n                        this.lastPiece = piece;\n                    }\n                }\n            } else if (piece.state === PIECE_STATE.PRESS) {\n                piece.setState(PIECE_STATE.IDLE);\n                this.lastPiece = null;\n            }\n        }, this);\n    }\n\n    canDirectLink(piece1: Piece, piece2: Piece): boolean {\n        if (piece1.x === piece2.x) {\n            let minY = Math.min(piece1.y, piece2.y);\n            let maxY = Math.max(piece1.y, piece2.y);\n            for (let y = minY + 1; y < maxY; y++) {\n                if (this.pieceMap[piece1.x][y].type !== 0) {\n                    return false\n                }\n            }\n            return true;\n        }\n        if (piece1.y === piece2.y) {\n            let minX = Math.min(piece1.x, piece2.x);\n            let maxX = Math.max(piece1.x, piece2.x);\n            for (let x = minX + 1; x < maxX; x++) {\n                if (this.pieceMap[x][piece1.y].type !== 0) {\n                    return false\n                }\n            }\n            return true;\n        }\n        return false;\n    }\n\n    findCorner(piece1: Piece, piece2: Piece): [boolean, Array<Piece>] {\n        let c1: Piece, c2: Piece;\n        // 0折\n        if (this.canDirectLink(piece1, piece2)) {\n            return [true, []];\n        }\n        // 1折 找一个点\n        c1 = this.pieceMap[piece1.x][piece2.y];\n        if (c1.type === 0 && this.canDirectLink(c1, piece1) && this.canDirectLink(c1, piece2)) {\n            return [true, [c1]];\n        }\n        c1 = this.pieceMap[piece2.x][piece1.y];\n        if (c1.type === 0 && this.canDirectLink(c1, piece1) && this.canDirectLink(c1, piece2)) {\n            return [true, [c1]];\n        }\n        // 2折 找一条线\n        for (let x = 0; x < this.colNum; x++) {\n            if (x === piece1.x || x === piece2.x) {\n                continue;\n            }\n            c1 = this.pieceMap[x][piece1.y];\n            c2 = this.pieceMap[x][piece2.y];\n            if (c1.type === 0 && c2.type === 0\n                && this.canDirectLink(c1, c2)\n                && this.canDirectLink(c1, piece1)\n                && this.canDirectLink(c2, piece2)) {\n                return [true, [c1, c2]];\n            }\n        }\n        for (let y = 0; y < this.colNum; y++) {\n            if (y === piece1.y || y === piece2.y) {\n                continue;\n            }\n            c1 = this.pieceMap[piece1.x][y];\n            c2 = this.pieceMap[piece2.x][y];\n            if (c1.type === 0 && c2.type === 0\n                && this.canDirectLink(c1, c2)\n                && this.canDirectLink(c1, piece1)\n                && this.canDirectLink(c2, piece2)) {\n                return [true, [c1, c2]];\n            }\n        }\n        return [false, null];\n    }\n\n    private link(piece1: Piece, piece2: Piece): boolean {\n        if (piece1.type !== piece2.type) {\n            return false;\n        }\n        let [pass, corners] = this.findCorner(piece1, piece2);\n        if (pass) {\n            this.drawLine([piece1].concat(corners).concat(piece2));\n            piece1.setType(0);\n            piece2.setType(0);\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    private drawLine(path: Piece[]) {\n        let pos = this.getPieceCenterPosition(path[0]);\n        this.pen.moveTo(pos.x, pos.y);\n        for (let i = 1; i < path.length; i++) {\n            pos = this.getPieceCenterPosition(path[i]);\n            this.pen.lineTo(pos.x, pos.y);\n        }\n        this.pen.stroke();\n        setTimeout(() => {\n            this.clearLine();\n        }, 500);\n    }\n\n    private clearLine() {\n        this.pen.clear();\n    }\n\n    private getPieceCenterPosition(piece: Piece): cc.Vec2 {\n        let x = piece.x * (this.colWidth + this.colSpace) + this.colSpace + this.colWidth / 2;\n        let y = piece.y * (this.colWidth + this.colSpace) + this.colSpace + this.colWidth / 2;\n        return cc.v2(x, y);\n    }\n\n    private shuffle() {\n        let pictureList = [];\n        for (let i = 1; i <= 78; i++) {\n            pictureList.push(i);\n        }\n        let pending = [];\n        for (let x = 1; x < this.colNum - 1; x++) {\n            for (let y = 1; y < this.colNum - 1; y++) {\n                pending.push(this.pieceMap[x][y]);\n            }\n        }\n        let p1, p2;\n        let pieceNum = (this.colNum - 2) ** 2;\n        let rem = pieceNum / 2 % this.pictureNum; // 余数，重复的几对\n        let coupleNum = (pieceNum / 2 - rem) / this.pictureNum; // 相同的图片有多少对\n        for (let i = 0; i < this.pictureNum; i++) {\n            let picture = this.randomPop(pictureList);\n            for (let j = 0; j < coupleNum * 2; j++) {\n                let p = this.randomPop(pending);\n                p.setType(picture);\n                p.setState(PIECE_STATE.IDLE);\n            }\n            if (i < rem) {\n                for(let k = 0; k < 2; k++) {\n                    let p = this.randomPop(pending);\n                    p.setType(picture);\n                    p.setState(PIECE_STATE.IDLE);\n                }\n            }\n        }\n    }\n\n    private randomPop(arr: Array<any>) {\n        let n = Math.random() * arr.length | 0;\n        return arr.splice(n, 1)[0];\n    }\n\n    public judgeWin(): boolean {\n        for (let x = 0; x < this.colNum; x++) {\n            for (let y = 0; y < this.colNum; y++) {\n                if (this.pieceMap[x][y].type !== 0) {\n                    return false;\n                }\n            }\n        }\n        this.linkScene.overGame();\n        return true;\n    }\n\n}"]}